---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Lindsey Weyant, Ali Raich, Aden Clemente"
date: "11/16/21"
output: pdf_document
---
```{r load-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)
library(sf)
library(viridis)
library(ggspatial)
#install.packages("usmap")
library(usmap)
# install.packages("tidycensus")
library(tidycensus)
 
measles <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-25/measles.csv')
```
 
 
#Load Data
```{r key}
census_api_key("abc8289fa2ba274ced76d97c7f8ee31666a2c931", overwrite = TRUE, install = TRUE)
 
if (FALSE) {
census_api_key("abc8289fa2ba274ced76d97c7f8ee31666a2c931", install = TRUE)
# First time, reload your environment so you can use the key without restarting R.
readRenviron("~/.Renviron")
# You can check it with:
Sys.getenv("CENSUS_API_KEY")
}
```
```{r censusdata}
#v18 <- load_variables(2018, "acs5", cache = TRUE)

#View(v18)
```

#Research Question:
 
How do measles vaccination rates vary across the country and demographics in schools?
 
overall vaccination status vs. state,
overall vaccination status vs. type of school,
each type of exemption (personal, religious, and medical) vs. state
exemption vs. type of school.
To analyze vaccination and exemption rates by states, we will use spatial data to show the change in these rates across the country.
Then, we can use two-sample t-tests to test for significance of vaccination and exemption rates between different types of schools.
If there are significantly lower vaccination rates in private schools vs. other types of schools, this will support our main hypothesis.
 
#Variable Manipulation
```{r variables, echo = FALSE}
measles <- measles %>%
  filter(overall != (-1)) %>%
  mutate(numvaxx = round(enroll*overall*.01)) %>%
  mutate(unvaxx = enroll - numvaxx)%>%
  
  mutate(numxmed = round(enroll*.01*xmed)) %>%
  mutate(numxmed = ifelse(is.na(numxmed), 0, numxmed)) %>%
  
  mutate(numxrel = round(enroll*.01*xrel)) %>%
  mutate(numxrel = ifelse(is.na(numxrel), 0, numxrel)) %>%
  
  mutate(numxper = round(enroll*.01*xper)) %>%
  mutate(numxper = ifelse(is.na(numxper), 0, numxper)) %>%
  
  mutate(numxother = unvaxx - numxper - numxmed - numxrel) %>%
  mutate(numxother = ifelse(is.na(numxother), 0, numxother)) %>%

  mutate(statefac = as.factor(state))
```
```{r nacheck, echo = FALSE}
measles2 <- measles %>%
filter(!is.na(overall), !is.na(type), !is.na(state))
```
```{r nacheck2, echo = FALSE}
measles2 %>%
  filter(state == "California") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Colorado") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Florida") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Idaho") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Iowa") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Michigan") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "New Jersey") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "North Carolina") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Ohio") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Oklahoma") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Oregon") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Rhode Island") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Tennessee") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Vermont") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Virginia") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Washington") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")

measles2 %>%
  filter(state == "Wisconsin") %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")
```
 
# Preliminary Bar Graphs
```{r bar, echo = FALSE}
measles %>%
  group_by(type) %>%
  mutate(averagevax = mean(overall)) %>%
  select(type, averagevax) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagevax)) +
  geom_col() +
  labs(title = "Measles Vaccination Rates Across Different School Types", x = "School Type", y = "Pecentage of Students Vaccinated")
measles %>%
  mutate(xrel = ifelse(is.na(xrel), 0, xrel)) %>%
  group_by(type) %>%
  mutate(averagerel = mean(xrel)) %>%
  select(type, averagerel) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagerel)) +
  geom_col() +
  labs(title = "Religious Exemption Rates Across Different School Types", x = "School Type", y = "Pecentage of Students with Religious Exemption")
measles %>%
  mutate(xper = ifelse(is.na(xper), 0, xper)) %>%
  group_by(type) %>%
  mutate(averageper = mean(xper)) %>%
  select(type, averageper) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averageper)) +
  geom_col() +
  labs(title = "Personal Exemption Rates Across Different School Types", x = "School Type", y = "Pecentage of Students with Personal Exemption")
measles %>%
  mutate(xmed = ifelse(is.na(xmed), 0, xmed)) %>%
  group_by(type) %>%
  mutate(averagemed = mean(xmed)) %>%
  select(type, averagemed) %>%
  distinct() %>%
  ggplot(aes(x = type, y = averagemed)) +
  geom_col() +
  labs(title = "Medical Exemption Rates Across Different School Types", x = "School Type", y = "Pecentage of Students with Medical Exemption")
```
 
# vaccination by state graph
 
```{r countstates}
measles %>%
  count(state) %>%
  group_by(state)
```
 
```{r vaxbystate}
measles %>%
  filter(overall != (-1)) %>%
  group_by(state) %>%
  summarise(statemean = mean(overall)) %>%
  ggplot(aes(x = statemean, y = reorder(state, statemean))) +
  geom_point() +
  labs(x = "Vaccination Rate", y = "State", title = "Vaccination Rate by State")
```
 
```{r vaxbystatemap}
plotdata <- measles %>%
filter(overall != (-1)) %>%
group_by(state) %>%
summarise(statemean = mean(overall))
plot_usmap(data=plotdata, values = "statemean") +
  labs(title = "Vaccination Rate by State", fill = "Vaccination Rate") +
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))
```
 

```{r income}
income <- get_acs(geography = "state", 
                       variables = "B07011_001",
                       year = 2018)

head(income)
```

```{r incomegraph}
income %>%
  filter(NAME %in% c("California", "Colorado", "Florida", "Idaho", "Iowa", "Michigan", "New Jersey", "North Carolina", "Ohio", "Oklahoma", "Oregon", "Rhode Island", "Tennessee", "Vermont", "Virginia", "Washington", "Wisconsin")) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_point() +
  scale_y_discrete() +
  labs(x = "Median Income", y = "State", title = "Median Income by State")
```
```{r race}
race <- get_acs(geography = "state", 
                       variables = "B02001_002",
                       year = 2018)

head(race)
```
```{r population}
population <- get_acs(geography = "state", 
                       variables = "B01003_001",
                       year = 2018)

head(population)
```
```{r join-pop-race}
#racerates <- left_join(race, population, by="GEOID") %>%
#pivot_wider(names_from = "variable", values_from = "estimate")
```



 # Logistic Regression
```{r logistic reg}
measlereg <- glm(cbind(numvaxx, unvaxx) ~ statefac, data=measles, family = binomial)
measlereg
summary(measlereg)
```